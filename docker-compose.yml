version: '3.5'

services:
  web_server:
    image: httpd@sha256:43c7661a3243c04b0955c81ac994ea13a1d8a1e53c15023a7b3cd5e8bb25de3c
    hostname: apache
    container_name: httpd-server
  modsec_crs:
    image: owasp/modsecurity-crs:4-apache-202404131004@sha256:9c20dd4756378de04c3587911efdf37c15614403c0540e008f16ca1cdbc63cba
    environment:
      PORT: 8080
      BACKEND: "http://apache:80"
      MODSEC_RULE_ENGINE: "On"
      PARANOIA: 4
      MODSEC_AUDIT_LOG_FORMAT: JSON
      MODSEC_AUDIT_LOG_TYPE: concurrent
      MODSEC_TMP_DIR: "/tmp"
      # Apache only
      SERVERNAME: _default_
      MODSEC_ERROR_LOG: "/dev/stderr"
      MODSEC_AUDIT_LOG: "/var/log/apache2/modsec_audit.log"
    hostname: crs-waf
    container_name: crs-waf
    depends_on:
      - web_server
  nuclei:
    image: projectdiscovery/nuclei:latest@sha256:7b22c9e323b41cfde605aef2c532c0abed1d7934cdcf8ba9b149ce46298400f0
    hostname: nuclei
    container_name: nuclei
    command: -u http://crs-waf:8080 -t http/cves -type http -stats -ni -sresp -jle output.json
    volumes:
      - ./output:/output:rw
    depends_on:
      - web_server
      - modsec_crs
