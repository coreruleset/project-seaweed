name: Run Nuclei
on:
  # Run every sunday
  schedule:
    - cron: "0 12 * * SUN"
  workflow_dispatch:
env:
  REPO_OWNER: ${{ github.repository_owner }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
  NUCLEI_VERSION: '3.2.5'
  POETRY_VERSION: '1.8.2'
jobs:
  project-runner:
    name: Project runner
    # seaweed configurations
    env:
      TAG: "lfi,xss,fileupload,xxe,injection,traversal,disclosure,auth-bypass,ssrf,sqli,oast,rce"
      WAF_IMAGE: "owasp/modsecurity-crs:4-apache-202404131004"
      HTTPD_IMAGE: "httpd:2.4"
      
    runs-on: ubuntu-latest
    services:
      apache:
        image: httpd:2.4
        ports:
          - 8088:80
      waf:
        image: owasp/modsecurity-crs:4-apache-202404131004
        env:
          MODSEC_RULE_ENGINE: "On"
          SERVERNAME: "_default_"
          MODSEC_AUDIT_LOG: "/var/log/apache2/modsec_audit.log"
          PARANOIA: 4
          BACKEND: "http://apache:8088"
        options: >-
            --health-interval 5s
        ports:
          - 8080:8080
    steps:
      - name: Checkout
        uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4

      - name: Nuclei - Vulnerability Scan
        uses: projectdiscovery/nuclei-action@main
        with:
          target: "http://localhost:8080"
          flags: "-tags ${{ env.TAG }}"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: GitHub Workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuclei.log
          path: nuclei.log
      
  success:
    name: Send success notification
    runs-on: ubuntu-latest
    needs: [project-runner]
    # runs only if last job was successful
    if: ${{ contains(join(needs.*.result, ','), 'success') }}
    steps:
      - name: Success
        uses: slackapi/slack-github-action@70cd7be8e40a46e8b0eced40b0de447bdb42f68e # v1.26.0
        with:
          payload: |
            {
            "text": "Testing finished!",
            "attachments": [
              {
                "color": "28a745",
                "fields": [
                  {
                    "title": "Status",
                    "value": "Complete"
                  },
                  {
                    "title": "cves tested",
                    "value": ${{ env.cves_tested }}
                  },
                  {
                    "title": "blocks",
                    "value": ${{ env.blocks }}
                  },
                  {
                    "title": "partial blocks",
                    "value": ${{ env.partial_blocks }}
                  },
                  {
                    "title": "non blocks",
                    "value": ${{ env.non_blocks }}
                  }
                ]
              }
              ]
            }
  failure:
    name: Send Failure notification
    runs-on: ubuntu-latest
    needs: [success]
    if: always()
    steps:
      - name: Failure
        # Runs if anything went wrong in any job
        if: ${{ !contains(join(needs.*.result, ','), 'success') }}
        uses: slackapi/slack-github-action@70cd7be8e40a46e8b0eced40b0de447bdb42f68e # v1.26.0
        with:
          payload: |
            {
            "text": "Seems like Seaweed ran into an error :/",
            "attachments": [
              {
                "color": "c91a23",
                "fields": [
                  {
                    "title": "Status",
                    "value": "Incomplete"
                  }
                ]
              }
              ]
            }
